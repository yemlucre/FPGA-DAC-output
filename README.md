# FPGA DAC 波形发生器

## 项目概述

本项目基于 **Xilinx Zynq-7020（xc7z020clg400-2）** FPGA，使用 **Vivado 2020.2** 开发，采用 **VHDL** 硬件描述语言实现了一个多波形数字模拟转换（DAC）输出系统。系统可通过板载按键实时切换三种波形，并将 14 位数字量输出至外部 DAC 芯片，从而在示波器上观察相应的模拟波形。

---

## 功能特性

| 功能 | 描述 |
|------|------|
| 波形种类 | 锯齿波、三角波、正弦波 |
| DAC 分辨率 | 14 位（最大值 16383） |
| 波形选择 | 3 个按键组合编码选择 |
| 暂停/继续 | 独立按键控制输出使能 |
| 状态指示 | 4 路 LED：心跳灯 + 波形选择指示 |
| 时钟输出 | 同步时钟（CLK_OUT）与写使能（WRT_OUT）直接输出给 DAC |

---

## 硬件平台

- **FPGA 芯片**：Xilinx Zynq-7020（xc7z020clg400-2）
- **I/O 电平标准**：LVCMOS33（3.3V）
- **时钟源**：板载 100 MHz 晶振（引脚 U18）
- **开发工具**：Vivado 2020.2

---

## 系统架构

```
                    ┌─────────────────────────────────────────┐
                    │               顶层模块 DAC               │
  clk (100MHz) ─────┤                                         ├──── wave[13:0]  → 外部DAC
  key[2:0] ─────────┤  ┌──────────┐  ┌──────────┐            ├──── clk_out     → DAC时钟
  key4 ─────────────┤  │ jc_wave  │  │ ak_wave  │            ├──── wrt_out     → DAC写使能
                    │  │ (锯齿波) │  │ (三角波) │            ├──── led0        → 选择指示
                    │  └──────────┘  └──────────┘            ├──── led1        → 选择指示
                    │  ┌──────────┐  ┌──────────┐            ├──── led2        → 选择指示
                    │  │sin_wave  │  │ LED_show │            ├──── led3        → 心跳灯
                    │  │ (正弦波) │  │ (心跳灯) │            │
                    │  └──────────┘  └──────────┘            │
                    └─────────────────────────────────────────┘
```

---

## 模块详解

### 1. 顶层模块 `DAC.vhd`

顶层模块负责例化所有子模块，并实现波形选择与输出控制逻辑。

**端口定义：**

| 端口名 | 方向 | 位宽 | 描述 |
|--------|------|------|------|
| `clk` | 输入 | 1 bit | 100 MHz 系统时钟 |
| `key[2:0]` | 输入 | 3 bit | 波形选择按键（低有效组合） |
| `key4` | 输入 | 1 bit | 暂停/继续控制键 |
| `wave[13:0]` | 输出 | 14 bit | 14 位波形数据输出至 DAC |
| `clk_out` | 输出 | 1 bit | 给 DAC 的同步时钟 |
| `wrt_out` | 输出 | 1 bit | 给 DAC 的写使能信号（与 clk 同步） |
| `led0` | 双向 | 1 bit | 选择锯齿波时翻转 |
| `led1` | 双向 | 1 bit | 选择三角波时翻转 |
| `led2` | 双向 | 1 bit | 选择正弦波时翻转 |
| `led3` | 输出 | 1 bit | 心跳灯（1 Hz 闪烁） |

**波形选择逻辑：**

| `key[2:0]` 输入值 | 对应波形 | 说明 |
|-------------------|----------|------|
| `"110"` | 锯齿波（jc_wave） | led0 翻转 |
| `"101"` | 三角波（ak_wave） | led1 翻转 |
| `"011"` | 正弦波（sin_wave） | led2 翻转 |
| 其他 | 默认（锯齿波） | — |

**暂停逻辑：**  
`key4` 每次下降沿（按下）将内部 `stop` 信号取反。当 `stop = '1'` 时，`wave` 输出强制为全 0，DAC 无信号输出；当 `stop = '0'` 时正常输出选定波形。

---

### 2. 锯齿波模块 `jc_wave.vhd`

产生线性递增的锯齿波形。

**实现思路：**

锯齿波的数学特征是幅度随时间线性增大，到达峰值后立即跌回零点，形成"快速复位"的锯齿形状。实现这一波形最直接的方法就是利用计数器的单调递增特性：

1. 定义一个 14 位无符号计数器 `cnt`，其取值范围恰好是 0 ~ 16383，与 DAC 的满量程完全对应。
2. 在每个时钟上升沿将 `cnt` 加 1。当 `cnt` 达到最大值 16383 时，下一拍手动将其清零（而非让其自然溢出，是为了语义明确、综合结果可控）。
3. 将 `cnt` 直接转换为 `STD_LOGIC_VECTOR` 输出给 DAC，计数器本身就是波形幅度的数字编码，无需任何额外运算。

```
幅度
16383 |         /|         /|
      |        / |        / |
      |       /  |       /  |
      |      /   |      /   |
      |     /    |     /    |
    0 |____/     |____/     |___→ 时间
      ←一个周期→
```

**输出波形特性：**
- 幅度：0 ~ 16383（满量程）
- 每个完整周期包含 16384 个时钟拍
- 在 100 MHz 时钟下：周期 = 16384 × 10 ns = 163.84 µs，频率 ≈ **6.1 kHz**

---

### 3. 三角波模块 `ak_wave.vhd`

产生线性上升后线性下降的三角波形。

**实现思路：**

三角波相比锯齿波多了一个"下降段"，因此需要在计数器之外引入一个**方向控制标志** `s` 来记录当前处于上升还是下降阶段，实现"往返计数"：

1. 定义 14 位无符号计数器 `cnt` 和 1 位方向标志 `s`（`'0'` = 上升，`'1'` = 下降）。
2. **上升阶段**（`s = '0'`）：每拍 `cnt` 加 1。当 `cnt` 达到峰值 16383 时，将 `s` 切换为 `'1'`，同时将 `cnt` 预设为 **16382**（而非继续停在 16383）。这样处理的目的是避免在峰值点重复输出两拍相同的值，保证上升和下降速率完全对称。
3. **下降阶段**（`s = '1'`）：每拍 `cnt` 减 1。当 `cnt` 达到谷值 0 时，将 `s` 切换为 `'0'`，同时将 `cnt` 预设为 **1**，同理避免在谷底重复停留。
4. 将 `cnt` 直接转换为 `STD_LOGIC_VECTOR` 输出给 DAC。

```
幅度
16383 |    /\        /\        /\
      |   /  \      /  \      /  \
      |  /    \    /    \    /    \
      | /      \  /      \  /      \
    0 |/        \/        \/        \→ 时间
      ←────── 一个完整周期 ─────────→
```

**关键设计细节：** 方向切换时对 `cnt` 的预赋值（16382 / 1）是保证波形**线性对称**的关键。若不做此处理，峰值和谷值处各会额外停留一个时钟周期，波形顶部和底部会出现微小平台，破坏三角波的线性度。

**输出波形特性：**
- 幅度：0 ~ 16383（满量程）
- 每个完整周期：上升段 16382 拍 + 下降段 16382 拍 = **32764 拍**
- 在 100 MHz 时钟下：周期 = 32764 × 10 ns ≈ 327.6 µs，频率 ≈ **3.05 kHz**

---

### 4. 正弦波模块 `sin_wave.vhd`

通过**查找表（LUT, Look-Up Table）** 方式产生正弦波形。

**实现思路：**

正弦函数是超越函数，FPGA 内部无法像加减法那样直接以组合逻辑实时计算，常见实现方案有两种：CORDIC 算法（多拍迭代逼近）和 LUT 预存法。本项目采用更简单、资源消耗固定的 **LUT 预存法**，核心思想是"以存储换计算"：

1. **离线预计算采样点**：在设计阶段，将完整正弦周期按下式将 sin 函数映射到 14 位无符号整数空间：

$$y[n] = \left\lfloor \frac{16383}{2} \cdot (1 + \sin\frac{2\pi n}{256}) \right\rfloor, \quad n = 0, 1, \ldots, 255$$

生成 256 个采样点，范围 0 ~ 16383，中心值约 8192 对应 $\sin=0$。256 个值以常量数组 `sine_lut` 的形式硬编码进 VHDL 源文件。

2. **综合为片上 ROM**：Vivado 综合时会将常量数组 `sine_lut` 自动推断为一块**分布式 RAM 或块 RAM（BRAM）**，实现只读存储功能，无需手动例化 RAM IP 核。

3. **地址步进读取**：定义 8 位寄存器 `addr`，每个时钟上升沿执行 `addr <= addr + 1`。由于 8 位计数器自然溢出（255 → 0），地址会在 0 ~ 255 之间无限循环，无需额外的归零判断逻辑。

4. **组合逻辑输出**：用 `addr` 作为索引，以组合逻辑直接读取对应 LUT 条目并输出给 DAC：
   ```vhdl
   dac_out <= sine_lut(to_integer(unsigned(addr)));
   ```
   每个时钟周期地址递增一次，DAC 输出依次跟随 LUT 中 256 个正弦采样值，形成连续正弦波。

**LUT 关键采样点验证：**

| 地址（对应相位）| 理论 sin 值 | LUT 存储值（近似十进制）| 说明 |
|----------------|-------------|-------------------------|------|
| 0（0°）| 0.000 | 8192 | 过零点，正向过零 |
| 64（90°）| +1.000 | 16383 | 正峰值 |
| 128（180°）| 0.000 | 8192 | 过零点，负向过零 |
| 192（270°）| −1.000 | 1 | 负峰值 |

```
幅度
16383 |     .---.             .---.
      |   ./     \.        ./     \.
 8192 |--/----------\------/----------\-→ 时间
      | /            \  ./             \
    0 |.              --.
      ←──── 256 个时钟拍 ───────────→
```

**为何选择 256 点？**  
采样点数决定波形平滑度和输出频率。256 点（8 位地址）在 100 MHz 系统时钟下可输出约 390 kHz 的正弦波，足以用示波器清晰观测，同时 LUT 仅占 256 × 14 bit = 3584 bit 存储空间，资源消耗极低，是精度与资源的合理平衡。

**输出波形特性：**
- 幅度：0 ~ 16383（满量程，直流偏置中心值 = 8192）
- 每个完整周期 = 256 个时钟拍
- 在 100 MHz 时钟下：周期 = 256 × 10 ns = 2.56 µs，频率 ≈ **390.6 kHz**

---

### 5. 心跳灯模块 `LED_show.vhd`

为 `led3` 提供 1 Hz 的规律闪烁，用于直观表明 FPGA 系统正常运行。

- 内部 26 位计数器 `cnt` 每拍加 1
- 当计数到 **49,999,999** 时清零，并翻转输出电平
- 在 100 MHz 时钟下：翻转周期 = 50,000,000 × 10 ns = **500 ms** → 输出频率 = **1 Hz**

---

## 引脚约束（XDC）

引脚分配文件：[DAC.srcs/constrs_1/new/DAC.xdc](DAC.srcs/constrs_1/new/DAC.xdc)

| 信号 | FPGA 引脚 | 电平标准 |
|------|-----------|----------|
| `clk` | U18 | LVCMOS33 |
| `key[0]` | N15 | LVCMOS33 |
| `key[1]` | N16 | LVCMOS33 |
| `key[2]` | T17 | LVCMOS33 |
| `key4` | R17 | LVCMOS33 |
| `led0` | M14 | LVCMOS33 |
| `led1` | M15 | LVCMOS33 |
| `led2` | K16 | LVCMOS33 |
| `led3` | J16 | LVCMOS33 |
| `wave[0]` | K17 | LVCMOS33 |
| `wave[1]` | K18 | LVCMOS33 |
| `wave[2]` | M19 | LVCMOS33 |
| `wave[3]` | M20 | LVCMOS33 |
| `wave[4]` | L19 | LVCMOS33 |
| `wave[5]` | L20 | LVCMOS33 |
| `wave[6]` | J18 | LVCMOS33 |
| `wave[7]` | H18 | LVCMOS33 |
| `wave[8]` | G19 | LVCMOS33 |
| `wave[9]` | G20 | LVCMOS33 |
| `wave[10]` | F19 | LVCMOS33 |
| `wave[11]` | F20 | LVCMOS33 |
| `wave[12]` | F16 | LVCMOS33 |
| `wave[13]` | F17 | LVCMOS33 |
| `wrt_out` | J19 | LVCMOS33 |
| `clk_out` | K19 | LVCMOS33 |

---

## 仿真测试

项目提供了四个 VHDL 仿真测试台（Testbench），位于 [DAC.srcs/sim_1/new/](DAC.srcs/sim_1/new/)。

### `tb_DAC.vhd` — 顶层系统仿真

对整个 DAC 系统进行功能验证，依次模拟四种按键输入场景：

| 仿真时段 | `key` 值 | 对应波形 | 持续时间 |
|----------|----------|----------|----------|
| 第 1 段 | `"110"` | 锯齿波 | 2 ms |
| 第 2 段 | `"101"` | 三角波 | 2 ms |
| 第 3 段 | `"011"` | 正弦波 | 2 ms |
| 第 4 段 | `"000"` | 默认/无效 | 2 ms |

- 仿真时钟周期：20 ns（对应 50 MHz，可在 testbench 中修改）
- `key4` 固定为高电平（不触发暂停），专注于验证波形切换逻辑

### `TB_JC.vhd` — 锯齿波单元仿真

- 单独例化 `jc_wave` 模块
- 时钟周期 20 ns，验证计数器递增与归零逻辑

### `TB_ak.vhd` — 三角波单元仿真

- 单独例化 `ak_wave` 模块
- 时钟周期 20 ns，验证上升/下降方向切换逻辑

### `tb_sin.vhd` — 正弦波单元仿真

- 单独例化 `sine_wave` 模块
- 时钟周期 10 ns，验证 LUT 地址循环与输出波形

---

## IP 核

项目包含一个 Vivado Clock Wizard IP 核（`clk_wiz`），配置文件位于 [DAC.srcs/sources_1/ip/clk_wiz/](DAC.srcs/sources_1/ip/clk_wiz/)。

- **目标器件**：xc7z020clg400-2
- **接口**：`clk_in1`（输入）、`clk_out1`（输出）、`reset`、`locked`
- 该 IP 核在本版本中已综合完成，综合检查点存放于 [DAC.runs/clk_wiz_synth_1/](DAC.runs/clk_wiz_synth_1/)

---

## 工程文件结构

```
FPGA-DAC-output-master/
├── DAC.xpr                          # Vivado 工程文件（入口）
├── DAC.srcs/
│   ├── sources_1/
│   │   ├── new/
│   │   │   ├── DAC.vhd              # 顶层模块
│   │   │   ├── jc_wave.vhd          # 锯齿波发生器
│   │   │   ├── ak_wave.vhd          # 三角波发生器
│   │   │   ├── sin_wave.vhd         # 正弦波发生器（LUT）
│   │   │   ├── LED_show.vhd         # 心跳灯模块
│   │   │   └── juchi_wave.vhd       # 预留（空文件）
│   │   └── ip/
│   │       └── clk_wiz/             # 时钟向导 IP 核
│   ├── constrs_1/
│   │   └── new/
│   │       └── DAC.xdc              # 引脚约束文件
│   └── sim_1/
│       └── new/
│           ├── tb_DAC.vhd           # 顶层系统仿真
│           ├── TB_JC.vhd            # 锯齿波仿真
│           ├── TB_ak.vhd            # 三角波仿真
│           └── tb_sin.vhd           # 正弦波仿真
├── DAC.runs/
│   ├── synth_1/                     # 综合结果
│   ├── impl_1/
│   │   └── DAC.bit                  # 已生成的比特流文件
│   └── clk_wiz_synth_1/             # IP 核综合结果
└── DAC.hw/                          # 硬件调试文件
```

---

## 如何使用

### 1. 打开工程

用 Vivado 2020.2 打开 `DAC.xpr`。

### 2. 运行仿真

在 Vivado 左侧 Flow Navigator 中，选择对应 Testbench 后点击 **Run Simulation → Run Behavioral Simulation**，观察 `wave` 总线的波形输出是否符合预期。

### 3. 综合与实现

点击 **Run Synthesis** → **Run Implementation**，工程已包含完整综合与实现结果，可直接查看时序报告和资源利用率报告（位于 `DAC.runs/impl_1/`）。

### 4. 下载比特流

比特流文件已生成：`DAC.runs/impl_1/DAC.bit`  
连接开发板后，在 Vivado Hardware Manager 中点击 **Program Device** 下载至 FPGA。

### 5. 实际操作

下载完成后，板子正常工作时 `led3`（心跳灯）会以 1 Hz 频率闪烁。

| 操作 | 效果 |
|------|------|
| 按下 `key[0]`（key="110"） | 输出锯齿波，`led0` 翻转 |
| 按下 `key[1]`（key="101"） | 输出三角波，`led1` 翻转 |
| 按下 `key[2]`（key="011"） | 输出正弦波，`led2` 翻转 |
| 按下 `key4` | 暂停/继续 DAC 输出（`wave` 全零） |

---

## 波形参数汇总

| 波形 | 采样点数 | 100 MHz 下的输出频率 | 幅度范围 |
|------|----------|----------------------|----------|
| 锯齿波 | 16384 | ≈ 6.1 kHz | 0 ~ 16383 |
| 三角波 | 32766 | ≈ 3.05 kHz | 0 ~ 16383 |
| 正弦波 | 256 | ≈ 390.6 kHz | 0 ~ 16383 |

---

## 开发环境

- **EDA 工具**：Xilinx Vivado 2020.2
- **硬件描述语言**：VHDL
- **目标器件**：Xilinx Zynq-7020（xc7z020clg400-2）
- **I/O 标准**：LVCMOS33

